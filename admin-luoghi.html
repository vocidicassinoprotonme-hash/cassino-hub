<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Luoghi & Recensioni</title>
  <style>
    :root{
      --bg:#0b0f1a; --card:#10182a; --line:rgba(255,255,255,.08);
      --txt:#eaf0ff; --muted:rgba(234,240,255,.72);
      --accent:#7c5cff; --ok:#27d17f; --bad:#ff4d4d;
      --shadow:0 12px 40px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:radial-gradient(900px 500px at 20% 10%, rgba(124,92,255,.20), transparent 60%),
                 radial-gradient(900px 500px at 80% 20%, rgba(39,209,127,.14), transparent 60%),
                 var(--bg);
      color:var(--txt);
    }
    header{
      display:flex; align-items:center; gap:10px;
      padding:16px 18px; border-bottom:1px solid var(--line);
      background:rgba(16,24,42,.7); backdrop-filter: blur(10px);
      position:sticky; top:0; z-index:10;
    }
    header h1{font-size:16px; margin:0}
    header .pill{
      margin-left:auto;
      padding:7px 10px; border:1px solid var(--line);
      border-radius:999px; background:rgba(255,255,255,.03);
      font-size:12px; color:var(--muted);
    }
    main{
      padding:16px;
      max-width:1100px;
      margin:0 auto;
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media(min-width: 920px){
      main{ grid-template-columns: 380px 1fr; }
    }
    .card{
      background:rgba(16,24,42,.85);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card h2{
      font-size:14px; margin:0;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.02);
    }
    .card .content{ padding:14px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input, textarea, select{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--txt);
      outline:none;
    }
    textarea{ min-height: 92px; resize: vertical; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{
      border:0; border-radius:12px;
      padding:10px 12px;
      background:rgba(255,255,255,.06);
      color:var(--txt);
      cursor:pointer;
      border:1px solid var(--line);
    }
    button.primary{ background: linear-gradient(135deg, var(--accent), rgba(124,92,255,.55)); }
    button.ok{ background: linear-gradient(135deg, var(--ok), rgba(39,209,127,.55)); }
    button.danger{ background: linear-gradient(135deg, var(--bad), rgba(255,77,77,.55)); }
    .muted{ color:var(--muted); font-size:12px; }
    .small{ font-size:12px; }
    .status{ margin-top:10px; font-size:12px; }
    .status.ok{ color:var(--ok); }
    .status.bad{ color:var(--bad); }
    .list{
      display:flex; flex-direction:column; gap:10px;
      max-height: 420px;
      overflow:auto;
      padding-right: 4px;
    }
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 10px;
      background:rgba(255,255,255,.02);
      cursor:pointer;
    }
    .item.active{ outline:2px solid rgba(124,92,255,.55); }
    .badges{ display:flex; gap:6px; flex-wrap:wrap; margin-bottom:6px; }
    .badge{
      font-size:11px; color:var(--muted);
      border:1px solid var(--line);
      padding:3px 7px; border-radius:999px;
      background:rgba(0,0,0,.16);
    }
    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media(min-width: 920px){
      .split{ grid-template-columns: 1fr 1fr; }
    }
    .hr{ height:1px; background:var(--line); margin:12px 0; }
  </style>
</head>
<body>
<header>
  <h1>üîê Admin Luoghi & Recensioni</h1>
  <div class="pill" id="pill">Non connesso</div>
</header>

<main>
  <!-- LEFT: CONFIG + CREATE PLACE -->
  <section class="card">
    <h2>Configurazione</h2>
    <div class="content">
      <label>Worker base URL</label>
      <input id="workerBase" placeholder="https://...workers.dev" />

      <label>Admin Key (solo per te)</label>
      <input id="adminKey" placeholder="inserisci la chiave admin" />

      <div class="btns">
        <button class="primary" id="btnSaveCfg">Salva</button>
        <button id="btnTest">Test connessione</button>
      </div>
      <div class="status" id="cfgStatus"></div>

      <div class="hr"></div>

      <h2 style="padding:0;margin:0 0 6px 0;font-size:14px;">Nuovo / Modifica Luogo</h2>

      <label>ID luogo (lascia vuoto per creare nuovo)</label>
      <input id="pId" placeholder="(vuoto = crea nuovo)" />

      <label>Categoria</label>
      <select id="pType">
        <option value="eat">üçΩÔ∏è Dove mangiare</option>
        <option value="shop">üõçÔ∏è Dove acquistare</option>
        <option value="visit">üìç Posti da visitare</option>
      </select>

      <label>Nome</label>
      <input id="pName" placeholder="Es: Pizzeria XYZ" />

      <label>Descrizione</label>
      <textarea id="pDesc" placeholder="Breve descrizione..."></textarea>

      <label>Indirizzo</label>
      <input id="pAddr" placeholder="Via..., Cassino" />

      <div class="row">
        <div>
          <label>Lat</label>
          <input id="pLat" inputmode="decimal" placeholder="41.49..." />
        </div>
        <div>
          <label>Lng</label>
          <input id="pLng" inputmode="decimal" placeholder="13.83..." />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Telefono</label>
          <input id="pPhone" placeholder="+39..." />
        </div>
        <div>
          <label>Sito web</label>
          <input id="pWeb" placeholder="https://..." />
        </div>
      </div>

      <label>Tag (separati da virgola)</label>
      <input id="pTags" placeholder="pizza, famiglia, economico" />

      <div class="btns">
        <button class="ok" id="btnSavePlace">Salva luogo</button>
        <button id="btnClearPlace">Pulisci</button>
      </div>

      <div class="status" id="placeStatus"></div>
      <p class="muted">Nota: i luoghi vengono salvati su D1 (tabella <b>places</b>).</p>
    </div>
  </section>

  <!-- RIGHT: LIST PLACES + REVIEWS -->
  <section class="card">
    <h2>Elenco luoghi & Recensioni</h2>
    <div class="content">
      <div class="row">
        <div>
          <label>Filtra per categoria</label>
          <select id="filterType">
            <option value="">Tutti</option>
            <option value="eat">üçΩÔ∏è Dove mangiare</option>
            <option value="shop">üõçÔ∏è Dove acquistare</option>
            <option value="visit">üìç Posti da visitare</option>
          </select>
        </div>
        <div>
          <label>Cerca testo</label>
          <input id="filterText" placeholder="cerca per nome/descrizione" />
        </div>
      </div>

      <div class="btns">
        <button class="primary" id="btnReload">Aggiorna lista</button>
        <button id="btnExportPlaces">Esporta luoghi JSON</button>
      </div>

      <div class="status" id="listStatus"></div>

      <div class="split" style="margin-top:12px;">
        <div>
          <div class="muted" style="margin-bottom:8px;">Luoghi (tocca per selezionare)</div>
          <div class="list" id="placeList"></div>
        </div>

        <div>
          <div class="muted" style="margin-bottom:8px;">Recensioni per il luogo selezionato</div>
          <div class="card" style="border-radius:14px;">
            <div class="content">
              <div class="muted small" id="selPlaceInfo">Nessun luogo selezionato.</div>

              <label>Voto (1-5)</label>
              <select id="rRating">
                <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5)</option>
                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4)</option>
                <option value="3">‚≠ê‚≠ê‚≠ê (3)</option>
                <option value="2">‚≠ê‚≠ê (2)</option>
                <option value="1">‚≠ê (1)</option>
              </select>

              <label>Titolo (opzionale)</label>
              <input id="rTitle" placeholder="Es: Ottimo!" />

              <label>Testo recensione (opzionale)</label>
              <textarea id="rBody" placeholder="Scrivi la recensione..."></textarea>

              <label>Autore (opzionale)</label>
              <input id="rAuthor" placeholder="Nome o anonimo" />

              <div class="btns">
                <button class="ok" id="btnAddReview">Aggiungi recensione</button>
                <button id="btnLoadReviews">Carica recensioni</button>
              </div>

              <div class="status" id="reviewStatus"></div>

              <div class="hr"></div>
              <div class="muted small" id="reviewSummary"></div>
              <div class="list" id="reviewList" style="max-height:220px;"></div>
            </div>
          </div>
        </div>
      </div>

      <p class="muted" style="margin-top:12px;">
        Endpoint usati: <b>/places</b>, <b>/reviews</b>, <b>/admin/place</b>, <b>/admin/review</b>
      </p>
    </div>
  </section>
</main>

<script>
const $ = (id) => document.getElementById(id);

const STATE = {
  base: "",
  key: "",
  places: [],
  selectedPlace: null
};

function saveCfg(){
  localStorage.setItem("ch_admin_base", STATE.base);
  localStorage.setItem("ch_admin_key", STATE.key);
}
function loadCfg(){
  STATE.base = localStorage.getItem("ch_admin_base") || "https://cassino-segnalazioni.vocidicassinoproton-me.workers.dev";
  STATE.key  = localStorage.getItem("ch_admin_key") || "";
  $("workerBase").value = STATE.base;
  $("adminKey").value = STATE.key;
  updatePill();
}
function updatePill(){
  $("pill").textContent = STATE.base ? "Connesso: " + new URL(STATE.base).host : "Non connesso";
}

function api(path){
  return STATE.base.replace(/\/+$/,"") + path;
}

function setStatus(el, msg, ok){
  el.textContent = msg || "";
  el.className = "status " + (ok ? "ok" : "bad");
}

async function testConn(){
  try{
    const res = await fetch(api("/places"));
    const j = await res.json();
    if(res.ok && j.ok){
      setStatus($("cfgStatus"), "OK: Worker raggiungibile ‚úÖ", true);
      return true;
    }
    setStatus($("cfgStatus"), "Risposta non valida ‚ùå", false);
    return false;
  }catch(e){
    setStatus($("cfgStatus"), "Errore rete / Worker non raggiungibile ‚ùå", false);
    return false;
  }
}

async function loadPlaces(){
  setStatus($("listStatus"), "Carico luoghi...", true);
  const type = $("filterType").value.trim();
  const q = $("filterText").value.trim().toLowerCase();

  const url = type ? api("/places?type=" + encodeURIComponent(type)) : api("/places");
  const res = await fetch(url);
  const j = await res.json();

  if(!res.ok || !j.ok){
    setStatus($("listStatus"), "Errore caricamento luoghi ‚ùå", false);
    return;
  }

  let rows = j.rows || [];
  if(q){
    rows = rows.filter(p =>
      (p.name||"").toLowerCase().includes(q) ||
      (p.description||"").toLowerCase().includes(q) ||
      (p.address||"").toLowerCase().includes(q)
    );
  }

  STATE.places = rows;
  renderPlaces();
  setStatus($("listStatus"), `OK: ${rows.length} luoghi caricati ‚úÖ`, true);
}

function renderPlaces(){
  const root = $("placeList");
  root.innerHTML = "";
  if(STATE.places.length === 0){
    root.innerHTML = `<div class="muted small">Nessun luogo. Aggiungine uno a sinistra.</div>`;
    return;
  }

  for(const p of STATE.places){
    const el = document.createElement("div");
    el.className = "item" + (STATE.selectedPlace?.id === p.id ? " active" : "");
    const typeLabel = p.type === "eat" ? "üçΩÔ∏è" : p.type === "shop" ? "üõçÔ∏è" : "üìç";
    el.innerHTML = `
      <div class="badges">
        <span class="badge">${typeLabel} ${p.type}</span>
        ${p.lat && p.lng ? `<span class="badge">GPS</span>` : `<span class="badge">No GPS</span>`}
      </div>
      <b>${escapeHTML(p.name||"")}</b>
      <div class="muted small">${escapeHTML(p.address||"")}</div>
      <div class="muted small">${escapeHTML((p.description||"").slice(0,90))}${(p.description||"").length>90?"‚Ä¶":""}</div>
      <div class="muted small">ID: ${escapeHTML(p.id)}</div>
    `;
    el.addEventListener("click", ()=>{
      STATE.selectedPlace = p;
      $("selPlaceInfo").textContent = `Selezionato: ${p.name} (ID: ${p.id})`;
      renderPlaces();
      loadReviews();
      // copia dati nel form a sinistra per modificare
      fillPlaceForm(p);
    });
    root.appendChild(el);
  }
}

function fillPlaceForm(p){
  $("pId").value = p.id || "";
  $("pType").value = p.type || "eat";
  $("pName").value = p.name || "";
  $("pDesc").value = p.description || "";
  $("pAddr").value = p.address || "";
  $("pLat").value = (p.lat ?? "") === null ? "" : (p.lat ?? "");
  $("pLng").value = (p.lng ?? "") === null ? "" : (p.lng ?? "");
  $("pPhone").value = p.phone || "";
  $("pWeb").value = p.website || "";
  $("pTags").value = Array.isArray(p.tags) ? p.tags.join(", ") : "";
}

function clearPlaceForm(){
  $("pId").value = "";
  $("pType").value = "eat";
  $("pName").value = "";
  $("pDesc").value = "";
  $("pAddr").value = "";
  $("pLat").value = "";
  $("pLng").value = "";
  $("pPhone").value = "";
  $("pWeb").value = "";
  $("pTags").value = "";
}

async function savePlace(){
  const payload = {
    id: $("pId").value.trim() || undefined,
    type: $("pType").value.trim(),
    name: $("pName").value.trim(),
    description: $("pDesc").value.trim() || null,
    address: $("pAddr").value.trim() || null,
    lat: $("pLat").value.trim() ? Number($("pLat").value.trim()) : null,
    lng: $("pLng").value.trim() ? Number($("pLng").value.trim()) : null,
    phone: $("pPhone").value.trim() || null,
    website: $("pWeb").value.trim() || null,
    tags: $("pTags").value.trim()
      ? $("pTags").value.split(",").map(s=>s.trim()).filter(Boolean)
      : []
  };

  if(!payload.name){
    setStatus($("placeStatus"), "Inserisci almeno il nome ‚ùå", false);
    return;
  }

  try{
    const res = await fetch(api("/admin/place"), {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "X-Admin-Key": STATE.key
      },
      body: JSON.stringify(payload)
    });

    const j = await res.json().catch(()=> ({}));
    if(res.ok && j.ok){
      setStatus($("placeStatus"), "Luogo salvato ‚úÖ", true);
      await loadPlaces();
      // seleziona se appena creato
      if(j.id){
        const found = STATE.places.find(x=>x.id===j.id);
        if(found){
          STATE.selectedPlace = found;
          $("selPlaceInfo").textContent = `Selezionato: ${found.name} (ID: ${found.id})`;
          renderPlaces();
        }
      }
    }else{
      setStatus($("placeStatus"), "Errore salvataggio ‚ùå " + (j.error||""), false);
    }
  }catch(e){
    setStatus($("placeStatus"), "Errore rete ‚ùå", false);
  }
}

async function loadReviews(){
  if(!STATE.selectedPlace){
    $("reviewSummary").textContent = "";
    $("reviewList").innerHTML = "";
    return;
  }
  setStatus($("reviewStatus"), "Carico recensioni...", true);

  try{
    const res = await fetch(api("/reviews?placeId=" + encodeURIComponent(STATE.selectedPlace.id)));
    const j = await res.json();
    if(!res.ok || !j.ok){
      setStatus($("reviewStatus"), "Errore caricamento recensioni ‚ùå", false);
      return;
    }

    const avg = (j.avgRating === null) ? "-" : Number(j.avgRating).toFixed(2);
    $("reviewSummary").textContent = `Recensioni: ${j.count} ‚Ä¢ Media: ${avg}`;
    renderReviews(j.rows || []);
    setStatus($("reviewStatus"), "Recensioni caricate ‚úÖ", true);
  }catch(e){
    setStatus($("reviewStatus"), "Errore rete ‚ùå", false);
  }
}

function renderReviews(rows){
  const root = $("reviewList");
  root.innerHTML = "";
  if(rows.length === 0){
    root.innerHTML = `<div class="muted small">Nessuna recensione per questo luogo.</div>`;
    return;
  }
  for(const r of rows){
    const el = document.createElement("div");
    el.className = "item";
    const stars = "‚≠ê".repeat(Number(r.rating||0));
    el.innerHTML = `
      <div class="badges">
        <span class="badge">${stars} (${r.rating})</span>
        <span class="badge">${new Date(r.createdAt).toLocaleString("it-IT")}</span>
        ${r.author ? `<span class="badge">${escapeHTML(r.author)}</span>` : ``}
      </div>
      ${r.title ? `<b>${escapeHTML(r.title)}</b>` : `<b>Recensione</b>`}
      ${r.body ? `<div class="muted small">${escapeHTML(r.body)}</div>` : ``}
    `;
    root.appendChild(el);
  }
}

async function addReview(){
  if(!STATE.selectedPlace){
    setStatus($("reviewStatus"), "Seleziona prima un luogo ‚ùå", false);
    return;
  }

  const payload = {
    placeId: STATE.selectedPlace.id,
    rating: Number($("rRating").value),
    title: $("rTitle").value.trim() || null,
    body: $("rBody").value.trim() || null,
    author: $("rAuthor").value.trim() || null
  };

  try{
    const res = await fetch(api("/admin/review"), {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "X-Admin-Key": STATE.key
      },
      body: JSON.stringify(payload)
    });
    const j = await res.json().catch(()=> ({}));
    if(res.ok && j.ok){
      setStatus($("reviewStatus"), "Recensione aggiunta ‚úÖ", true);
      $("rTitle").value = "";
      $("rBody").value = "";
      $("rAuthor").value = "";
      await loadReviews();
    }else{
      setStatus($("reviewStatus"), "Errore ‚ùå " + (j.error||""), false);
    }
  }catch(e){
    setStatus($("reviewStatus"), "Errore rete ‚ùå", false);
  }
}

function exportPlaces(){
  const blob = new Blob([JSON.stringify(STATE.places, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "places.json";
  a.click();
  URL.revokeObjectURL(a.href);
}

function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
  }[m]));
}

// =====================
// EVENTS
// =====================
$("btnSaveCfg").addEventListener("click", ()=>{
  STATE.base = $("workerBase").value.trim();
  STATE.key  = $("adminKey").value.trim();
  saveCfg();
  updatePill();
  setStatus($("cfgStatus"), "Salvato ‚úÖ", true);
});

$("btnTest").addEventListener("click", async ()=>{
  STATE.base = $("workerBase").value.trim();
  STATE.key  = $("adminKey").value.trim();
  saveCfg();
  updatePill();
  await testConn();
});

$("btnReload").addEventListener("click", loadPlaces);
$("filterType").addEventListener("change", loadPlaces);
$("filterText").addEventListener("input", ()=> {
  // micro debounce
  clearTimeout(window.__t);
  window.__t = setTimeout(loadPlaces, 250);
});

$("btnSavePlace").addEventListener("click", savePlace);
$("btnClearPlace").addEventListener("click", ()=>{
  clearPlaceForm();
  setStatus($("placeStatus"), "", true);
});

$("btnAddReview").addEventListener("click", addReview);
$("btnLoadReviews").addEventListener("click", loadReviews);

$("btnExportPlaces").addEventListener("click", exportPlaces);

// INIT
loadCfg();
testConn().then(loadPlaces);
</script>
</body>
</html>
